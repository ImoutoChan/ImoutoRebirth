<UserControl x:Class="ImoutoRebirth.Navigator.Slices.IntegrityReport.IntegrityReportsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:converters="clr-namespace:ImoutoRebirth.Common.WPF.Converters;assembly=ImoutoRebirth.Common.WPF"
             xmlns:localConverters="clr-namespace:ImoutoRebirth.Navigator.Converters"
             xmlns:settingsSlice="clr-namespace:ImoutoRebirth.Navigator.ViewModel.SettingsSlice"
             xmlns:integrityReport="clr-namespace:ImoutoRebirth.Navigator.Slices.IntegrityReport"
             xmlns:viewModels="clr-namespace:ImoutoRebirth.Navigator.Slices.IntegrityReport.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="700"
             d:DesignWidth="450"
             d:DataContext="{d:DesignInstance viewModels:IntegrityReportsVM, IsDesignTimeCreatable=False}">
    <UserControl.Resources>
        <converters:ConditionVisibilityConverter x:Key="ConditionVisibilityConverter" />

        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <!-- Style for ProgressBar without gradient -->
        <Style x:Key="FlatProgressBar" TargetType="ProgressBar" BasedOn="{StaticResource MahApps.Styles.ProgressBar}">
            <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Accent}" />
            <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Gray8}" />
        </Style>

        <!-- ListBoxItem style without blue selection background -->
        <Style x:Key="ReportListBoxItem" TargetType="ListBoxItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Margin" Value="0,2,10,2" />
            <Setter Property="Padding" Value="5" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Accent}" />
                </Trigger>

                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Gray9}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Status badge style -->
        <Style x:Key="StatusBadge" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Accent}" />
            <Setter Property="CornerRadius" Value="3" />
            <Setter Property="Padding" Value="6,2" />
        </Style>

        <!-- Section header style -->
        <Style x:Key="SectionHeader" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Gray3}" />
            <Setter Property="Margin" Value="0,5,0,8" />
        </Style>
    </UserControl.Resources>

    <Grid Margin="15,15,5,15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header with New Report button -->
        <DockPanel Grid.Row="0" Margin="0,0,10,10">

            <Button Content="New Report"
                    Command="{Binding ShowCreateReportCommand}"
                    DockPanel.Dock="Right"
                    Visibility="{Binding IsCreatingReport, Converter={StaticResource ConditionVisibilityConverter}, ConverterParameter=false}" />

            <Button Content="Refresh"
                    Command="{Binding LoadReportsCommand}"
                    DockPanel.Dock="Right"
                    Margin="10,0,10,0"
                    HorizontalAlignment="Right"
                    Visibility="{Binding IsCreatingReport, Converter={StaticResource ConditionVisibilityConverter}, ConverterParameter=false}" />

            <TextBlock Text="Integrity Reports"
                       FontSize="17"
                       FontWeight="Bold"
                       VerticalAlignment="Center" />
        </DockPanel>

        <!-- Create Report Panel -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Border Grid.Row="0"
                    BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                    BorderThickness="1"
                    Padding="10"
                    Margin="0,0,10,10"
                    Visibility="{Binding IsCreatingReport, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel HorizontalAlignment="Stretch">
                    <TextBlock Text="Create New Report"
                               FontSize="14"
                               FontWeight="Bold"
                               Margin="0,0,0,10" />

                    <TextBlock Text="Collections" Style="{StaticResource SectionHeader}" />

                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="0,0,0,5">
                        <Button Content="Select All"
                                Command="{Binding SelectAllCollectionsCommand}"
                                Margin="0,0,5,0"
                                Padding="5,2" />

                        <Button Content="Deselect All"
                                Command="{Binding DeselectAllCollectionsCommand}"
                                Padding="5,2" />
                    </StackPanel>

                    <ListBox ItemsSource="{Binding AvailableCollections}"
                             Margin="0,15,0,15">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type viewModels:SelectableCollectionVM}">
                                <CheckBox IsChecked="{Binding IsSelected}"
                                          Content="{Binding Name}" />
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <TextBlock Text="Save Location" Style="{StaticResource SectionHeader}" />
                    <TextBox Text="{Binding SaveReportPath, UpdateSourceTrigger=PropertyChanged}"
                             controls:TextBoxHelper.Watermark="Leave empty for default"
                             Margin="0,0,0,15" />

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel"
                                Command="{Binding CancelCreateReportCommand}"
                                Margin="0,0,10,0" />

                        <Button Content="Build Report"
                                Command="{Binding CreateReportCommand}" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Reports List -->
        <Grid Grid.Row="1"
              Visibility="{Binding IsCreatingReport, Converter={StaticResource ConditionVisibilityConverter}, ConverterParameter=false}">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <ListBox Grid.Row="0"
                     ItemsSource="{Binding Reports}"
                     SelectedItem="{Binding SelectedReport}"
                     ItemContainerStyle="{StaticResource ReportListBoxItem}"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type viewModels:IntegrityReportItemVM}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Date and Status Badge -->
                            <DockPanel Grid.Row="0">
                                <Border DockPanel.Dock="Right" Style="{StaticResource StatusBadge}">
                                    <TextBlock Text="{Binding Status}"
                                               Foreground="White"
                                               FontWeight="SemiBold"
                                               FontSize="11" />
                                </Border>
                                <TextBlock Text="{Binding StartedOnFormatted}"
                                           FontWeight="Bold"
                                           VerticalAlignment="Center" />
                            </DockPanel>

                            <!-- Collections -->
                            <TextBlock Grid.Row="1"
                                       Text="{Binding CollectionNames}"
                                       TextTrimming="CharacterEllipsis"
                                       Foreground="{DynamicResource MahApps.Brushes.Gray3}"
                                       FontSize="12"
                                       Margin="0,4,0,4" />

                            <!-- Progress -->
                            <Grid Grid.Row="2">
                                <ProgressBar Value="{Binding ProgressPercent, Mode=OneWay}"
                                             Minimum="0"
                                             Maximum="100"
                                             Height="18"
                                             Style="{StaticResource FlatProgressBar}"
                                             IsIndeterminate="{Binding IsBuilding}" />

                                <TextBlock Text="{Binding ProgressPercent, StringFormat='{}{0:F1}%'}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           ToolTip="{Binding ProgressText}" />
                            </Grid>

                            <!-- ETA -->
                            <TextBlock Grid.Row="3"
                                       Text="{Binding EstimatedTimeRemaining}"
                                       Foreground="{DynamicResource MahApps.Brushes.Accent}"
                                       FontSize="11"
                                       Margin="0,3,0,0"
                                       Visibility="{Binding EstimatedTimeRemaining, Converter={StaticResource ConditionVisibilityConverter}, ConverterParameter=!null}" />
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- Load More Button -->
            <Button Grid.Row="1"
                    Content="Load More"
                    Command="{Binding LoadMoreReportsCommand}"
                    Margin="0,5,10,0"
                    HorizontalAlignment="Stretch"
                    Visibility="{Binding HasMoreItems, Converter={StaticResource BooleanToVisibilityConverter}}" />
        </Grid>

        <!-- Loading Indicator -->
        <controls:ProgressRing Grid.Row="1"
                               IsActive="{Binding IsLoading}"
                               Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />

        <!-- Selected Report Details -->
        <Border Grid.Row="2"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1"
                Padding="10"
                Margin="0,10,10,0"
                MaxHeight="300"
                Visibility="{Binding SelectedReport, Converter={StaticResource ConditionVisibilityConverter}, ConverterParameter=!null}">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,5,0">
                <StackPanel DataContext="{Binding SelectedReport}">
                    <DockPanel Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                            <Button Content="Pause"
                                    Command="{Binding DataContext.PauseReportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    Visibility="{Binding CanPause, Converter={StaticResource BooleanToVisibilityConverter}}" />

                            <Button Content="Resume"
                                    Command="{Binding DataContext.ResumeReportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    Visibility="{Binding CanResume, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        </StackPanel>

                        <TextBlock Text="Report Details"
                                   FontSize="14"
                                   FontWeight="Bold"
                                   VerticalAlignment="Center" />
                    </DockPanel>

                    <TextBlock Text="Collections" Style="{StaticResource SectionHeader}" />

                    <ItemsControl ItemsSource="{Binding Collections}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type viewModels:IntegrityReportCollectionItemVM}">
                                <StackPanel Margin="0,8,0,8" Tag="{Binding}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="65" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="95" />
                                            <ColumnDefinition Width="60" />
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Column="0"
                                                Background="{DynamicResource MahApps.Brushes.Accent}"
                                                CornerRadius="3"
                                                Padding="4,1"
                                                Margin="0,0,5,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Status}"
                                                       Foreground="White"
                                                       FontSize="10" />
                                        </Border>

                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding CollectionName}"
                                                   TextTrimming="CharacterEllipsis"
                                                   VerticalAlignment="Center"
                                                   FontWeight="SemiBold" />

                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding ProgressText}"
                                                   FontSize="10"
                                                   Foreground="{DynamicResource MahApps.Brushes.Gray3}"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Right"
                                                   Margin="0,0,10,0" />

                                        <Grid Grid.Column="3">
                                            <ProgressBar Value="{Binding ProgressPercent, Mode=OneWay}"
                                                         Minimum="0"
                                                         Maximum="100"
                                                         Height="16"
                                                         Style="{StaticResource FlatProgressBar}" />

                                            <TextBlock Text="{Binding ProgressPercent, StringFormat='{}{0:F0}%'}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       FontSize="10" />
                                        </Grid>
                                    </Grid>

                                    <!-- Report files links -->
                                    <ItemsControl ItemsSource="{Binding ReportFiles}"
                                                  Margin="20,2,0,0"
                                                  Visibility="{Binding HasReportFiles, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Margin="0,0,10,0">
                                                    <Hyperlink Command="{Binding Tag.OpenReportFileCommand, RelativeSource={RelativeSource AncestorType=StackPanel, AncestorLevel=2}}"
                                                               CommandParameter="{Binding}"
                                                               Foreground="{DynamicResource MahApps.Brushes.AccentBase}">
                                                        <Run Text="{Binding Mode=OneWay, Converter={x:Static integrityReport:FilePathToFileNameConverter.Instance}}" />
                                                    </Hyperlink>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Open folder link -->
                    <TextBlock Margin="0,5,0,0"
                               Visibility="{Binding HasExportToFolder, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Hyperlink Command="{Binding OpenReportFolderCommand}">
                            <Run Text="Open reports folder" />
                        </Hyperlink>
                    </TextBlock>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>
